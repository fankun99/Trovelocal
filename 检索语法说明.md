# 检索语法

1.平台使用 **Meilisearch**（一个简单易用、高性能的全文搜索引擎）对上传的文档和爬取的网页中的文本等信息进行存储、分词、检索。

2.平台的检索语法类似 **Elasticsearch** ，可使用**键值对**（字段:关键词）、**逻辑符**（与、或、非）和**组合**符号（括号）对内容进行搜索。我们设计了这套检索语法，并在用户查询时将它转义为meilisearch的请求。

## 1. 语句构造

查询语句的基本组成是**查询键值对**、**逻辑符**、**组合符号**。语句的形式如下：

```
<字段名1>:<关键词1> [ < 逻辑符 > <字段名n>:<关键词n> ]
```

不使用键值对而是直接输入关键词也是可以的，平台在解析时会自动为这些词设置一个键"content"（即全文字段）。

下面是一些查询语句的例子：

```
title:fortivpn && content:CVE-2025
(tag:“内网渗透” && date:2025) || (tag:"域渗透" && content:凭据)
超人 蝙蝠侠
"十四五规划"
date:2008 && 奥运
tag:"物理" 楞次定律
刑法 第十条
```

## 2.检索表达式

检索表达式由**字段名**和**关键词**组成，中间使用冒号分隔。

```
字段名:"关键词"  或  字段名:关键词
```

关键词中如果带有空格，则需要在两边加上双引号，同时，关键词如果加上了双引号，也意味着进行精准匹配，此时关键词不会被分词。

## 3.字段名

平台支持检索的字段如下：

| 字段名   | 说明                                                | 类型     | 检索示例           |
| :------- | :-------------------------------------------------- | -------- | :----------------- |
| id       | 数据库中的唯一标识符                                | filter   | `id:123`           |
| title    | 文档标题（用户自定义的标题或者文件名、html的title） | 全文字段 | `title:教程`       |
| content  | 内容（从文档中提取的可视文本）                      | 全文字段 | `content:内网漏洞` |
| user     | 上传用户                                            | filter   | `user:admin`       |
| tag      | 标签                                                | filter   | `tag:科技`         |
| keywords | 高频词                                              | filter   | `keywords:AI`      |
| file     | 文件名                                              | 全文字段 | `file:test.txt`    |
| date     | 创建日期                                            | 全文字段 | `date:2024/01/01`  |
| summary  | 摘要                                                | 全文字段 | `summary:"刑法"`   |
| remark   | 备注                                                | 全文字段 | `remark:test`      |

- 全文字段：表示在meilisearch中可以做全文搜索的字段，比如我们将文档内容、标题、摘要等都设置为了全文字段，这样用户就可以对这些字段的值进行快速高效的全文检索。
- filter字段：表示meilisearch中的过滤字段。设置为filter的字段不能使用全文检索和模糊检索，它是精准匹配的。平台把标签、用户名、高频词等设置为filter，为用户提供精准匹配，比如我要搜索一个文档，如果我已经知道它的标签是“内网渗透”，那么就不需要分词对标签做全文检索，否则可能把标签是“内容”和标签是“渗透”的文档一起搜索出来，导致我们想找的文档淹没在杂乱的海洋中。

## 4.逻辑符

平台支持的逻辑关系符号包括：

| 含义 | 符号 | 例子                               | 备注                               |
| ---- | ---- | ---------------------------------- | ---------------------------------- |
| 与   | &&   | title:fortivpn && content:CVE-2025 | 只能对filter类型的字段之间起作用   |
| 或   | \|\| | date:2024 \|\| date:2025           | 只能对filter类型的字段之间起作用   |
| 非   | -    | -"该公众号文章已删除"              | 只能对全文字段起作用，表示“不包含” |
| 组合 | ()   | (tag:“内网渗透” && date:2025)      |                                    |

逻辑符号和检索表达式之间需要用空格进行分隔。



**特别说明：**

由于meilisearch不支持直接对全文类型的字段进行逻辑关系的组合检索，比如不支持搜索"**全文中既包含123又包含456的文档**"， 如**content:123 && content:456**，所以我们使用了meilisearch的multi search（多重检索）对此进行了优化。

以“搜素全文字段中既包含123又包含456的文档”为例子，用户的检索语句是**content:123 && content:456**，那么后端程序首先会提取出该语句中所有的查询全文字段的关键词（在这里是 **123** 和 **456**）以及额外可能存在的filter检索语句，然后以json中的数组形式提交到multi search接口。例如

```
{
    "federation": {
        "limit": 5,
        "offset": 0
    },
    "queries": [
      {
        "indexUid": "articles",
        "q": "123 456"
      },
      {
        "indexUid": "articles",
        "q": "123"
      },
      {
        "indexUid": "articles",
        "q": "456"
      }
    ]
}
```

这样meilisearch就会把多个查询结果在一次响应中一并返回。虽然使用了multi search，让用户能够使用一个检索语句查询多个关键词了，但meilisearch的轻量化设计并不支持在multi search中对多个查询进行逻辑关系的处理，比如AND、OR ，而是通过meilisearch的排名规则对返回结果进行排序，比如其中一个排名规则"word"，以下是官网的解释：

`words`规则从右到左工作。因此，查询字符串的顺序会影响结果的顺序，例如，如果有人要搜索`batman dark knight`，则`words`规则会把同时包含三个关键词的文档排在第一位，只包含`batman`和`dark`的文档排在第二位，只包含`batman`的文档排在第三位。也就是说，meilisearch本来就会返回这些关键字同时存在的文档，又由于我们把这些关键词都各自拆分了单独去查询，因此meilisearch在多重查询中既会返回这些关键词的都存在的文档，也会返回某几个同时存在的文档，最后还会返回那些单独包含这些关键词的文档，meilisearch会自己合并去重，因此不必担心重复的问题。

基于平台现有的设计，即便用户在查询语句中使用了逻辑符（与、或）对全文字段进行逻辑关系组合查询（例如content:123 && content:456），我们也并未对查询结果进行逻辑关系的处理，而是仅仅对filter类型的检索表达式之间进行了逻辑关系处理（meilisearch仅仅支持filter类型的字段进行AND、OR、等于、不等于、大于、小于的处理）。根据上文，你应该知道**meilisearch的返回中会优先携带所有关键词都出现的文档并排列在最前面（当然你可以修改排名规则列表实现其他效果），之后是那些单独包含这些单个关键词的文档，因此相当于它会给你全部是“AND”关系的结果以及全部是“OR”关系的结果。**如果你想要更精细的控制全文类型关键词之间的逻辑关系，你需要去修改meilisearch结果处理这块的逻辑来自己实现一下，我认为当前的模式已经适用于大部分情况了。

想了解更多，可以查看meilisearch的官方文档：

- [排名规则](https://www.meilisearch.com/docs/learn/getting_started/indexes#ranking-rules)
- [filter查询](https://www.meilisearch.com/docs/learn/getting_started/indexes#displayed-and-searchable-attributes)
- [多重联合检索](https://www.meilisearch.com/docs/learn/multi_search/performing_federated_search)



## 5.查询例子

1. `title:"安装手册"` 	精确匹配标题为“安装手册”的文档。
2. `content:更新 && user:"admin"` 文档内容有“更新”且上传者是“admin”。
3. `(title:API || content:接口) && date:2025/05/01`   标题中有“API”或文档内容有“接口”，并且文档创建日期为2025年5月1日。



